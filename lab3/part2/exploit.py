#!/usr/bin/env python3

"""
"""

# ------------------------------- MODULE INFO ---------------------------------
__all__ = ["buffer_size_find"]
# ------------------------------- MODULE INFO ---------------------------------

# --------------------------------- MODULES -----------------------------------
import argparse
import os
import shutil
import signal
import subprocess
# --------------------------------- MODULES -----------------------------------

# ------------------------------ TYPE ALIASES ---------------------------------
# ------------------------------ TYPE ALIASES ---------------------------------


# -------------------------------- FUNCTIONS ----------------------------------
def buffer_size_find(program: str):
    """
    Find and print the minimum number of letters that can cause a buffer
    overflow.
    """

    if not isinstance(program, str):
        raise TypeError("'program' must be of 'str' type")

    if not shutil.which(program):
        raise ValueError("The given 'program' is not found")

    buffer_size = None
    buffer_found = False
    high = 1
    input_byte = b"0"
    low = None
    high_found = False
    output_info = "The minimum number of letters that caused overflow is: {0}"

    while not high_found:
        with subprocess.Popen([program], stdin=subprocess.PIPE) as proc:
            proc.communicate(input_byte * high)
            # iteratively double 'high' as long as no 'SIGSEGV' signal
            # is delivered
            if proc.returncode != -signal.SIGSEGV:
                high *= 2
            else:
                high_found = True

    low = high // 2
    buffer_size = (low + high) // 2

    while not buffer_found:
        with subprocess.Popen([program], stdin=subprocess.PIPE) as proc:
            proc.communicate(input_byte * buffer_size)
            if proc.returncode != -signal.SIGSEGV:
                low = buffer_size + 1
            else:
                buffer_found = True

            buffer_size = (low + high) // 2

    print(output_info.format(buffer_size))


def main():
    """
    Main command line driver.
    """

    parser = argparse.ArgumentParser()
    attr_desc_dict = {
        "executable": "path to the 'weak' executable",
    }

    for flag, msg in attr_desc_dict.items():
        parser.add_argument("-" + flag[0],
                            "--" + flag,
                            type=str,
                            required=False,
                            help=msg)

    args = parser.parse_args()

    if all(getattr(args, attr) for attr in attr_desc_dict):
        for attr in attr_desc_dict:
            buffer_size_find(getattr(args, attr))

# -------------------------------- FUNCTIONS ----------------------------------


if __name__ == "__main__":
    main()
